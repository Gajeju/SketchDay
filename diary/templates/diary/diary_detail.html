
{% extends "base/navbar.html" %}

{% load static %}


{% block title %}{{ diary.title }} | SketchDay{% endblock title %}

{% block content %}

<!-- Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratingModalLabel">추천 노래 평가하기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16" id="first">
          <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16" id="second">
          <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16" id = "third">
          <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16" id="fourth">
          <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16" id=fifth>
          <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
        </svg>
        <span id='score'></span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="save_rating">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div class="post-detail">
    <div class="header">
      <a href="{% url 'main' %}">&lt; 목록으로</a>
      {% if diary.author == user%}
      <div class="buttons">
        <a class="btn btn-primary btn-sm" href="{% url 'diary-delete' diary.id%}">삭제</a>
        <a class="btn btn-primary btn-sm" href="{% url 'diary-update' diary.id%}">수정</a>
        {%if not diary.rate%}
          <div id='ratingMusic'>
            <a class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#ratingModal">평가</a>
          </div>
        {%endif%}
      </div>
      {% endif %}
    </div>
    <article>
      {% if diary.image %}
        <img class="image" src="{{ diary.image.url }}">
      {% endif %}
      <div class="post-meta">
          <div class="item-info">  
            <div  class="title">{{ diary.title }} </div>
            <span class="date">{{ diary.dt_created|date:"Y.m.d" }}</span>
            
      </div>
        
      <a class="profile-link" href="{% url 'profile' diary.author.id %}">
      <div class="podo-box gray-background profile">
      <div class="profile-pic" style="background-image: url('{{ diary.author.profile_pic.url }}')"></div>
      <div class="profile-info">
      <div class="nickname">{{ diary.author.nickname }}</div>
     </div>
    </div>
  </a>
    <p class="item-detail">
      {{ diary.content |linebreaksbr }}
    </p>  
    <p>{{ diary.emotion_val }}</p>
    </article>
    <h2>감정 상태</h2>
    <div style="display: flex; justify-content: center">
      <div class="chart-container" style="height: 500px; width:500px">
        <p style="text-align: center; font-size: 1.5rem">오늘은 {{ diary.emotion }} 하셨군요!</p>
        <div>
          <canvas id="myChart"></canvas>
        </div>
      </div>
    </div>
    <p>{{ music.title }}</p>
    <p>{{ music.lyric }}</p>
    <p>{{ rec_diary.title }}</p>
    <p>{{ rec_diary.content }}</p>

</div>
<script>
var emotion_pie = document.getElementById('myChart').getContext('2d');
var emotionPieChart = new Chart(emotion_pie, {
    type: 'pie',
    data:{
        labels: [ '불안', '분노' , '슬픔' , '평온' , '행복' ],
        datasets: [{
            data: {{ diary.emotion_value }},
            backgroundColor: [
                "#f7323f",
                "#673ba7",
                "#ff6384",
                "#cc65fe",
                "#ffce56",
            ],
            borderWidth: 0
        }]
    }
});

// rating system
const one = document.getElementById('first')
const two = document.getElementById('second')
const three = document.getElementById('third')
const four = document.getElementById('fourth')
const five = document.getElementById('fifth')
const num = document.getElementById('score')

const handleSelect = (selection) => {
  switch(selection) {
    case 'first' : {
      one.setAttribute("fill", "red")
      two.setAttribute("fill", "currentColor")
      three.setAttribute("fill", "currentColor")
      four.setAttribute("fill", "currentColor")
      five.setAttribute("fill", "currentColor")
      num.innerText = 1
      return
    }
    case 'second' : {
      one.setAttribute("fill", "red")
      two.setAttribute("fill", "red")
      three.setAttribute("fill", "currentColor")
      four.setAttribute("fill", "currentColor")
      five.setAttribute("fill", "currentColor")
      num.innerText = 2
      return
    }
    case 'third' : {
      one.setAttribute("fill", "red")
      two.setAttribute("fill", "red")
      three.setAttribute("fill", "red")
      four.setAttribute("fill", "currentColor")
      five.setAttribute("fill", "currentColor")
      num.innerText = 3
      return
    }
    case 'fourth' : {
      one.setAttribute("fill", "red")
      two.setAttribute("fill", "red")
      three.setAttribute("fill", "red")
      four.setAttribute("fill", "red")
      five.setAttribute("fill", "currentColor")
      num.innerText = 4
      return
    }
    case 'fifth' : {
      one.setAttribute("fill", "red")
      two.setAttribute("fill", "red")
      three.setAttribute("fill", "red")
      four.setAttribute("fill", "red")
      five.setAttribute("fill", "red")
      num.innerText = 5
      return
    }
  }
}

const arr = [one, two, three, four, five]

arr.forEach(item=> item.addEventListener('mouseover', (event)=> {
  handleSelect(event.target.id)
}))

// save rating score with ajax
const btnAjax = document.getElementById("save_rating")
const diary_id = {{ diary.id }}
const music_id = {{ music.id }}

const x = document.getElementById("ratingMusic")

btnAjax.addEventListener('click', e => {
  console.log(num.innerText)
  const param = {
    'diary_id' : diary_id,
    'music_id' : music_id,
    'score' : num.innerText,
  }

  $.ajaxSetup({
    headers : {'X-CSRFToken':'{{csrf_token}}'}
  })

  $.ajax({
    url : 'http://127.0.0.1:8000/diary/rating/',
    type : 'POST',
    data : JSON.stringify(param),
    success:function(data) {
      x.style.display = "none"
      console.log('success')
    },
    error : function(data) {
      console.log('fail')
    }
  })
})

</script>

{% endblock content %}
